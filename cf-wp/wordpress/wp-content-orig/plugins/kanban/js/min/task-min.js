function Task(e){this.record=e,this.build_el()}Task.prototype.board=function(){return boards[this.record.board_id]},Task.prototype.add_to_board=function(){var e=$("#status-{0}-tasks".sprintf(this.record.status_id));this.$el.prependTo(e)},Task.prototype.build_el=function(){this.record.status=this.board().record.status_records()[this.record.status_id]?this.board().record.status_records()[this.record.status_id]:{},this.record.project=this.board().record.project_records[this.record.project_id]?this.board().record.project_records[this.record.project_id]:{},this.record.estimate=this.board().record.estimate_records()[this.record.estimate_id]?this.board().record.estimate_records()[this.record.estimate_id]:{},this.record.user_assigned=this.board().record.allowed_users()[this.record.user_id_assigned]?this.board().record.allowed_users()[this.record.user_id_assigned]:{},this.record.hour_count_formatted=format_hours(this.record.hour_count);var e=kanban.templates[this.board().record.id()]["t-task"].render({task:this.record,estimate_records:obj_order_by_prop(this.board().record.estimate_records(),"position"),project_records:this.board().record.project_records,allowed_users:this.board().record.allowed_users(),current_user_can_write:this.board().current_user().has_cap("write"),show_task_ids:1==this.board().record.settings().show_task_ids});this.$el=$(e),encode_urls_emails($(".task-title",this.$el)),this.dom(),$(document).trigger("/task/added/",this)},Task.prototype.dom=function(){var self=this;if(self.update_progress(),!self.board().current_user().has_cap("write"))return!1;self.$el.on("click",".btn-task-delete",function(){var e=$(this);return $(".glyphicon",e).show(),self.delete(),!1}),self.$el.on("click",".btn-task-copy",function(){$(this).closest(".dropdown").removeClass("open");var e=self.record.status_id,t=self.board().record.status_records()[e],r=0;if(void 0!==t.wip_task_limit&&(r=t.wip_task_limit),r>0){if($("#status-"+e+" .status-task-count").text()>=r)return notify(kanban.text.status_wip_task_limit_error,"warning"),!1}var a={task:self.record,action:"copy_task",kanban_nonce:$("#kanban_nonce").val()};return $.ajax({method:"POST",url:kanban.ajaxurl,data:a}).done(function(e){try{if(!e.success)return notify(kanban.text.task_added_error),!1;0===Object.keys(self.board().record.tasks).length&&(self.board().record.tasks={});var t=self.board().record.tasks[e.data.task.id]=new Task(e.data.task);t.add_to_board(),t.board().update_UI(),t.board().update_task_positions()}catch(e){}}),!1}),self.$el.on("shown.bs.dropdown",".dropdown",function(){var e=$(this);$(".task.active",self.board().$el).not(self.$el).removeClass("active"),self.$el.addClass("active")}).on("hidden.bs.dropdown",function(){self.$el.removeClass("active")}),self.$el.on("show.bs.dropdown",".task-project",function(){var e=$(this),t=$(".dropdown-menu",e).empty(),r=0;for(var a in self.board().record.project_records){var s=self.board().record.project_records[a],o=kanban.templates[self.board().record.id()]["t-task-project-dropdown"].render(s);$(o).prependTo(t),r++}if(0==r)return!1}).on("hide.bs.dropdown",".task-project",function(){var e=$(this);if($("[contenteditable]",e).is(":focus"))return!1}).on("keydown",".task-project [contenteditable]",function(e){var t=$(this),r=t.closest(".dropdown");if(27===e.keyCode){var a=t.data("orig");return t.html(a),t.blur(),clearTimeout(t.data("save_timer")),void(r.hasClass("open")&&r.removeClass("open"))}return 13===e.keyCode?(t.blur(),void(r.hasClass("open")&&r.removeClass("open"))):32===e.keyCode?(t.html(t.html()+"&nbsp;"),placeCaretAtEnd(t.get(0)),!1):void 0}).on("blur",".task-project [contenteditable]",function(){if(window.getSelection().removeAllRanges(),!self.board().current_user().has_cap("write"))return!1;var e=setTimeout(function(){self.parse_project()},100);$(this).data("save_timer",e)}).on("focus",".task-project [contenteditable]",function(){if(!self.board().current_user().has_cap("write"))return!1;var e=$(this);e.data("orig",e.text())}),self.$el.on("click",".btn-project-assign",function(){var e=$(this),t=e.closest(".dropdown"),r=$("[contenteditable]",t);clearTimeout(r.data("save_timer"));var a=e.attr("data-id");self.project_save(a)}),self.$el.on("click",".task-title",function(e){if(!$(e.target).is("a")){if(!self.board().current_user().has_cap("write"))return!1;var t=$(this);if(t.attr("contenteditable",t.attr("data-contenteditable")),"true"!=t.attr("contenteditable"))return!1;t.data("orig",t.html()),strip_tags(t),t.focus()}}).on("keydown",".task-title",function(e){if(!self.board().current_user().has_cap("write"))return!1;var t=$(this);if(27===e.keyCode){var r=t.data("orig");return t.html(r),void t.blur()}return 13!==e.keyCode||e.shiftKey?void 0:void t.blur()}).on("keyup",".task-title",function(){if(!self.board().current_user().has_cap("write"))return!1;var e=$(this);clearTimeout(e.data("save_timer"));var t=setTimeout(function(){self.save_title()},3e3);e.data("save_timer",t)}).on("blur",".task-title",function(){window.getSelection().removeAllRanges();var e=$(this);if(encode_urls_emails(e),e.removeAttr("contenteditable"),!self.board().current_user().has_cap("write"))return!1;self.save_title()}),self.$el.on("mouseenter",".btn-task-action",function(){var e=$(this),t=e.closest(".dropdown");if(t.is(".open"))return!1;var r=setTimeout(function(){if(t.is(".open"))return!1;e.trigger("click")},500);e.data("timer-open",r)}).on("mouseleave",".btn-task-action",function(){var e=$(this),t=e.closest(".dropdown");if(clearTimeout(e.data("timer-open")),t.is(".open")){var r=setTimeout(function(){t.removeClass("open")},500);t.data("timer-close",r)}}).on("mouseenter",".dropdown-menu",function(){var e=$(this),t=e.closest(".dropdown");clearTimeout(t.data("timer-close"))}),self.$el.on("show.bs.dropdown",".row-task-actions .dropdown",function(e){var t=$(e.relatedTarget),r=t.closest(".dropdown");$(".dropdown-menu",r).css("maxWidth",self.$el.outerWidth())}),self.$el.on("click",".btn-task-move",function(){var e=$(this),t=e.attr("data-target"),r=$(t);$(".task-id",r).val(self.record.id),$(".task-title",r).html(self.record.title)}),self.$el.on("click",".btn-task-estimate",function(){var e=$(this),t=e.attr("data-id"),r=self.board().record.estimate_records()[t],a=kanban.text.task_estimate_updated.sprintf(self.board().current_user().record().short_name,r.title);if(void 0!==self.board().record.estimate_records()[self.record.estimate_id]){var s=self.board().record.estimate_records()[self.record.estimate_id];if(t==self.record.estimate_id)return!0;a+=kanban.text.task_estimate_updated_previous.sprintf(s.title)}self.record.estimate_id=t,self.save(a),$(".task-estimate",self.$el).html(r.title),self.update_progress()}),self.$el.on("click",".btn-task-assigned",function(){var e=$(this),t=e.attr("data-id");if(t==self.record.user_id_assigned)return!0;var r=self.board().record.allowed_users()[t],a=kanban.text.task_assigned_to.sprintf(self.board().current_user().record().short_name,r.short_name);if(void 0!==self.board().record.allowed_users()[self.record.user_id_assigned]){var s=self.board().record.allowed_users()[self.record.user_id_assigned];if(t==self.record.user_id_assigned)return!0;a+=kanban.text.task_assigned_to_previous.sprintf(s.short_name)}self.record.user_id_assigned=t,self.save(a),self.update_assigned_to(t)}),self.$el.on("click",".btn-task-hour",function(){var $btn=$(this),operator=$btn.attr("data-operator");if("+"!=operator&&"-"!=operator)return!1;var current=void 0!==self.record.hour_count?parseFloat(self.record.hour_count):0,interval=self.board().record.settings().hour_interval;return current=eval(current+operator+interval),current=Math.round(1e3*current)/1e3,current<0&&(current=0),self.record.hour_count=current,$(".task-hours",self.$el).html(format_hours(self.record.hour_count)),self.update_progress(),self.log_work_hour(operator),!1}),self.$el.on("mousedown",".btn-task-hour",function(){var e=$(this),t=setInterval(function(){clearInterval(e.data("click_timer"));var t=setInterval(function(){e.trigger("click")},100);e.data("click_timer",t)},500);e.data("click_timer",t)}).on("mouseup mouseleave",".btn-task-hour",function(){var e=$(this);clearInterval(e.data("click_timer"))})},Task.prototype.update_progress=function(){var e=0;if(void 0!==this.record.estimate_id||void 0!==this.record.hour_count){var t=this.board().record.estimate_records()[this.record.estimate_id];if(void 0!==t){e=100*parseFloat(this.record.hour_count)/parseFloat(t.hours);var r="success";e>133?r="danger":e>100&&(r="warning"),e>100&&(e=100),$(".progress-bar",this.$el).css({width:e+"%"}).removeClass("progress-bar-success progress-bar-warning progress-bar-danger").addClass("progress-bar-"+r)}}},Task.prototype.save=function(e,t){if(!this.board().current_user().has_cap("write"))return!1;var r=this,a=JSON.parse(JSON.stringify(this.record));delete a.comments;var s={task:a,action:"save_task",kanban_nonce:$("#kanban_nonce").val()};void 0!==e&&null!==e&&""!==e&&(s.comment=e),void 0===t&&(t=!0),s.message=t,$.ajax({method:"POST",url:kanban.ajaxurl,data:s}).done(function(e){if(!e.success)return notify(kanban.text.task_save_error),!1;r.board().update_UI()})},Task.prototype.delete=function(){if(!this.board().current_user().has_cap("write"))return!1;var e=this;this.record.is_active=0;var t={task:this.record,action:"delete_task",kanban_nonce:$("#kanban_nonce").val(),comment:kanban.text.task_deleted.sprintf(e.board().current_user().record().short_name)};$.ajax({method:"POST",url:kanban.ajaxurl,data:t}).done(function(t){if(!t.success)return notify(kanban.text.task_delete_error),!1;$(document).trigger("/task/deleted/",e)}),e.delete_el()},Task.prototype.delete_el=function(e){void 0===e&&(e=!0);var t=this;t.$el.slideUp("fast",function(){e&&t.undelete_el(),t.$el.remove(),t.board().update_UI(),t.board().update_task_positions(),delete t.board().record.tasks[t.record.id]})},Task.prototype.undelete_el=function(){var e=this,t=$('<div class="alert alert-warning alert-task-restore" id="task-{0}-restore" role="alert" data-id="{1}">{2}</div>'.sprintf(e.record.id,e.record.id,kanban.text.task_restore)).insertAfter(e.$el);if(setTimeout(function(){t.slideUp("fast",function(){t.remove()})},8e3),!this.board().current_user().has_cap("write"))return!1;t.on("click",function(){var r=t.attr("data-id");t.html('<span class="hidden-xs glyphicon glyphicon-refresh glyphicon-refresh-animate"></span>');var a={task:{id:r},action:"undelete_task",kanban_nonce:$("#kanban_nonce").val(),comment:kanban.text.task_undeleted.sprintf(e.board().current_user().record().short_name)};$.ajax({method:"POST",url:kanban.ajaxurl,data:a}).done(function(e){if(!e.success)return!1;kanban.updates_task(),t.remove(),$(document).trigger("/task/undeleted/",r)})})},Task.prototype.update_status=function(e){if(!this.board().current_user().has_cap("write"))return!1;var t=this.board().record.status_records()[e];$(".task-handle",this.$el).css({"background-color":t.color_hex})},Task.prototype.update_position=function(e,t){if(!this.board().current_user().has_cap("write"))return!1;if(e==this.record.position)return!1;t="true"===t||!0===t,e=parseInt(e);var r=null;if(t){var a=this.record.position+"",r=kanban.text.task_moved_to_position.sprintf(this.board().current_user().record().short_name,e);""!==a&&(r+=kanban.text.task_moved_to_position_previous.sprintf(parseInt(a)))}this.record.position=e,this.save(r,!1)},Task.prototype.update_assigned_to=function(e){if(!this.board().current_user().has_cap("write"))return!1;var t=this,r=t.board().record.allowed_users()[e];t.$el.attr("data-user_id-assigned",e);var a=$(".task-assigned-initials",t.$el).removeClass("empty");void 0!==r.avatar?a.html(r.avatar):a.text(r.initials),$(".task-assigned-name",t.$el).text(r.short_name)},Task.prototype.save_title=function(){var e=$(".task-title",this.$el);clearTimeout(e.data("save_timer"));var t=this.record.title+"";sanitize(e);var r=e.html().replace(/\\/gi,"&#92;").replace(/&nbsp;/gi," ");if(e.is(":focus")||(encode_urls_emails(e),e.removeAttr("contenteditable")),r===t)return!1;var a=kanban.text.task_title_updated.sprintf(this.board().current_user().record().short_name,r);""!==t&&(a+=kanban.text.task_title_updated_previous.sprintf(t)),""===r&&(a=null),this.record.title=r,this.save(a)},Task.prototype.project_update_title=function(e){$(".task-project [contenteditable]",this.$el).text(e)},Task.prototype.project_save=function(e){isNaN(e)&&(e=0),this.$el.attr("data-project-id",e);var t=this.board().record.project_records[e];if(void 0===t?this.project_update_title(""):this.project_update_title(t.title),e!=this.record.project_id){if(void 0===t)var r=kanban.text.task_removed_from_project.sprintf(this.board().current_user().record().short_name);else var r=kanban.text.task_added_to_project.sprintf(this.board().current_user().record().short_name,t.title);var a=this.record.project_id,s=this.board().record.project_records[a];void 0!==s&&(r+=kanban.text.task_added_to_project_previous.sprintf(s.title)),this.record.project_id=e,this.save(r)}},Task.prototype.parse_project=function(){var e=this,t=$(".task-project [contenteditable]",this.$el);sanitize(t),strip_tags(t,[]);var r=$.trim(t.html());if(void 0!==(r=r.replace(/\\/gi,"|").replace(/&nbsp;/gi," "))&&null!==r){if(""===r)return void this.project_save(0);var a=null;for(var s in this.board().record.project_records){var o=this.board().record.project_records[s];if(r===$.trim(o.title)){a=o.id;break}}if(null!==a)return void this.project_save(a);Project.prototype.add(e.board().record.id(),r,function(){e.project_save(this.data.project.id)})}},Task.prototype.log_work_hour=function(e){if(!this.board().current_user().has_cap("write"))return!1;var t={task:this.record,action:"add_task_hour",kanban_nonce:$("#kanban_nonce").val(),operator:e};$.ajax({method:"POST",url:kanban.ajaxurl,data:t})};