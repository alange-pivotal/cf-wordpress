function Board(t,s){(null==s||isNaN(s))&&(s=50),$(document).trigger("/board/init/",t),this.record=t,this.$el=$("#board-{0}".sprintf(t.id()));var e=new User(this.record.allowed_users()[this.record.current_user_id()]);this.current_user=function(){return e},this.update_UI_done=!0,this.dom();var r=this;setTimeout(function(){var t=obj_order_by_prop(r.record.tasks,"position",!0);for(var s in t){var e=t[s];(r.record.tasks[e.id]=new Task(r.record.tasks[e.id])).add_to_board()}r.update_UI(),$(document).trigger("/board/tasks/done/",r)},s)}Board.prototype.dom=function(){var t=this;if($(document).trigger("/board/dom/",t.$el),t.$el.on("click",".col-tasks-sidebar",function(s){if("click"==s.type&&kanban.is_dragging)return!1;var e=$(this),r=$(".row-statuses, .row-tasks",t.$el);if(r.is(":animated"))return!1;var a=e.attr("data-left"),o=e.attr("data-right");return e.hasClass("opened")?(e.removeClass("opened"),a=o):e.addClass("opened"),$(".col-tasks-sidebar",t.$el).not(e).removeClass("opened"),r.animate({marginLeft:a},300),!1}),t.$el.on("change",".modal-filter select",function(){var s=$(this),e=s.attr("data-field"),r=s.val();return t.record.filters[e]=r,t.apply_filters(),!1}).on("show.bs.modal",".modal-filter",function(){var s=$(this),e=$(".select-projects",s),r=$("option:first",e),a=$("option:last",e);$("option",e).not(r).not(a).remove();for(var o in t.record.project_records){var i=t.record.project_records[o],n=kanban.templates[t.record.id()]["t-option-project"].render(i);$(n).insertAfter(r),t.apply_filters()}}),t.$el.on("click",".btn-status-toggle",function(){var s=$(this),e=s.closest(".col"),r=e.siblings().andSelf(),a=parseInt(s.attr("data-operator")),o=e.index()+a;o<0&&(o=r.length-1),o>=r.length&&(o=0),t.status_cols_toggle(o)}),!t.current_user().has_cap("write"))return!1;$(".col-tasks",t.$el).sortable({connectWith:".col-tasks",handle:".task-handle",forcePlaceholderSize:!0,forceHelperSize:!0,placeholder:"task-placeholder",containment:$(".row-tasks-wrapper",t.$el),appendTo:"body",scroll:!1,helper:"clone",start:function(s,e){$(".dropdown.open",t.$el).removeClass("open").closest(".col-tasks.active").removeClass("active"),$(".col-tasks-sidebar").css({left:"",right:""}),kanban.is_dragging=!0},stop:function(s,e){t.update_task_positions(e.item),kanban.is_dragging=!1},receive:function(s,e){var r=e.item.closest(".col-tasks"),a=e.item.attr("data-id"),o=t.record.tasks[a],i=o.record.status_id,n=t.record.status_records()[i],d=r.attr("data-status-id"),c=t.record.status_records()[d],u=0;if(void 0!==c.wip_task_limit&&(u=c.wip_task_limit),u>0){if($("#status-"+d+" .status-task-count").text()>=u)return $(e.sender).sortable("cancel"),notify(kanban.text.status_wip_task_limit_error,"warning"),!1}var l=kanban.text.task_moved_to_status.sprintf(t.current_user().record().short_name,c.title);l+=kanban.text.task_moved_to_status_previous.sprintf(n.title),void 0!==t.record.settings().default_assigned_to_first&&(1!=t.record.settings().default_assigned_to_first||void 0!==o.record.user_id_assigned&&0!=o.record.user_id_assigned||(o.record.user_id_assigned=t.current_user().record().ID,o.update_assigned_to(t.current_user().record().ID))),o.record.status_id=d,o.save(l),t.record.tasks[a].update_status(d),t.update_UI()}}),t.$el.on("mouseenter",".col-tasks",function(){var t=$(this),s=t.attr("data-status-id");return $("#status-"+s).trigger("mouseenter"),!1}).on("mouseleave",".col-tasks",function(){var t=$(this),s=t.attr("data-status-id");return $("#status-"+s).trigger("mouseleave"),!1}).on("shown.bs.dropdown",".col-tasks .dropdown",function(){return $(this).closest(".col-tasks").addClass("active"),!1}).on("hidden.bs.dropdown",".col-tasks .dropdown",function(){return $(this).closest(".col-tasks").removeClass("active"),!1}),t.$el.on("mouseenter",".col-status",function(){var t=$(this),s=t.attr("data-id");return $(".btn-group-status-actions",t).show(),!1}).on("mouseleave",".col-status",function(){var t=$(this),s=t.attr("data-id");return $(".btn-group-status-actions",t).hide(),!1}),t.$el.on("click",".btn-task-new",function(){var s=$(this);$(".glyphicon",s).toggle();var e=s.attr("data-status-id"),r=t.record.status_records()[e],a=0;if(void 0!==r.wip_task_limit&&(a=r.wip_task_limit),a>0){if($("#status-"+e+" .status-task-count").text()>=a)return notify(kanban.text.status_wip_task_limit_error,"warning"),!1}var o={task:{status_id:e,board_id:t.record.id()},comment:"{0} added the task".sprintf(t.current_user().record().short_name)};void 0!==t.record.settings().default_estimate&&void 0!==t.record.estimate_records()[t.record.settings().default_estimate]&&(o.task.estimate_id=t.record.settings().default_estimate);try{1==t.record.settings().default_assigned_to_creator&&(o.task.user_id_assigned=t.current_user().record().ID)}catch(t){}if(void 0!==t.record.settings().default_assigned_to&&void 0!==t.record.allowed_users()[t.record.settings().default_assigned_to]){var i=!0;try{1!=t.record.settings().default_assigned_to_creator&&1!=t.record.settings().default_assigned_to_first||(i=!1)}catch(t){}i&&(o.task.user_id_assigned=t.record.settings().default_assigned_to)}return o.action="save_task",o.kanban_nonce=$("#kanban_nonce").val(),$.ajax({method:"POST",url:kanban.ajaxurl,data:o}).done(function(e){$(".glyphicon",s).toggle();try{if(!e.success)return notify(kanban.text.task_added_error),!1;0===Object.keys(t.record.tasks).length&&(t.record.tasks={});(t.record.tasks[e.data.task.id]=new Task(e.data.task)).add_to_board(),t.update_UI(),t.update_task_positions(),$(".task-title",t.record.tasks[e.data.task.id].$el).trigger("click")}catch(t){}}),!1}),t.$el.on("click",".btn-status-empty",function(){if(window.confirm(kanban.text.status_empty_confirm)){var s=$(this),e=s.attr("data-status-id");$(".glyphicon",s).toggle();for(var r in t.record.tasks){var a=t.record.tasks[r];a.record.status_id==e&&a.delete()}setTimeout(function(){$(".glyphicon",s).toggle()},2e3)}return!1}),t.$el.on("click",".modal-task-move .list-group-item",function(){var s=$(this),e=s.closest(".modal"),r=$("input.task-id",e),a=r.val(),o=t.record.tasks[a],i=s.attr("data-status-id");if(o.record.status_id!=i){o.record.status_id=i;var n=s.attr("data-board-id");if(o.record.board_id!=n){var d=parseInt(o.record.board_id+"");o.record.board_id=n,boards[n].record.tasks[a]=o,delete boards[d].record.tasks[a]}o.save();var c=$("#task-"+a);setTimeout(function(){c.slideUp("fast",function(){o.update_status(i),$(this).prependTo("#status-"+i+"-tasks").slideDown("fast",function(){$(".btn-task-move",this).attr("data-target","#modal-task-move-"+n),t.update_UI()})})},300),t.match_col_h(),t.updates_status_counts()}}),$(window).resize(function(){$(".col-tasks",t.$el).sortable("xs"==screen_size?"disable":"enable")}),$(".col-tasks",t.$el).sortable("xs"==screen_size?"disable":"enable")},Board.prototype.updates_status_counts=function(){$(".col-tasks",this.$el).each(function(){var t=$(this),s=$(".task",t).length,e=t.attr("data-status-id");$("#status-"+e+" .status-task-count").text(s)})},Board.prototype.update_card_order=function(){var t=this;$(".col-tasks",this.$el).each(function(){var s=$(this),e=s.children(".task").get();e.sort(function(s,e){var r=$(s).attr("data-id"),a=t.record.tasks[r],o=parseInt(a.record.position),i=$(e).attr("data-id"),n=t.record.tasks[i],d=parseInt(n.record.position);return o<d?-1:o>d?1:0}),$.each(e,function(t,e){s.append(e)})})},Board.prototype.update_task_positions=function(t){var s=this;$(".col-tasks",this.$el).each(function(){var e=$(this);$(".task",e).each(function(e){var r=$(this),a=!1;r.is(t)&&(a=!0);var o=r.attr("data-id"),i=s.record.tasks[o];setTimeout(function(){i.update_position(("00000"+e).slice(-5),a)},100*e)})})},Board.prototype.match_col_h=function(){$(".col-tasks",this.$el).matchHeight({minHeight:window_h})},Board.prototype.apply_filters=function(){var t=this,s=[],e=!1;for(var r in this.record.filters){var a=this.record.filters[r];if(null!==a&&""!==a){e=!0;for(var o in this.record.tasks){this.record.tasks[o].record[r]!=a&&s.push("#task-"+o)}$('.modal-filter select[data-field="{0}"]'.sprintf(r),this.$el).val(a)}}e?$(".btn-filter-reset").show():$(".btn-filter-reset").hide();var i=$(s.join(","));i.slideUp("fast"),$(".task").not(i).slideDown("fast"),$(".task",this.$el).promise().done(function(){t.match_col_h()}),kanban.url_params=$.extend(kanban.url_params,{filters:this.record.filters}),update_url()},Board.prototype.project_update_counts=function(){var t=[];for(var s in this.record.tasks){var e=this.record.tasks[s];void 0!==e.record.project_id&&(void 0===t[e.record.project_id]&&(t[e.record.project_id]=0),t[e.record.project_id]++)}for(var r in this.record.project_records)void 0!==t[r]?this.record.project_records[r].task_count=t[r]:this.record.project_records[r].task_count=0},Board.prototype.update_UI=function(){var t=this;t.update_UI_done&&(t.update_UI_done=!1,this.update_card_order(),this.updates_status_counts(),this.match_col_h(),setTimeout(function(){t.update_UI_done=!0},5e3))},Board.prototype.status_cols_toggle=function(t){kanban.url_params.col_index=t,update_url(),$(".row-statuses, .row-tasks",this.$el).each(function(){var s=$(this),e=$("> .col",s),r=e.eq(t).show();e.not(r).hide()})},Board.prototype.status_cols_show_all=function(){$(".row-statuses, .row-tasks",this.$el).each(function(){var t=$(this);$("> .col",t).show()})},Board.prototype.get_current_board_id=function(){return parseInt(current_board_id)},Board.prototype.get_current_board=function(){var t=Board.prototype.get_current_board_id();return void 0!==boards[t]&&boards[t]};